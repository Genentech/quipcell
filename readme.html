<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>quipcell &#8212; quipcell 0.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=89af775e" />
    <script src="_static/documentation_options.js?v=48f8e935"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example application of quipcell to human lung cell atlas" href="vignette.html" />
    <link rel="prev" title="quipcell" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <!-- These are examples of badges you might want to add to your README:
     please update the URLs accordingly

[![Built Status](https://api.cirrus-ci.com/github/<USER>/quipcell.svg?branch=main)](https://cirrus-ci.com/github/<USER>/quipcell)
[![ReadTheDocs](https://readthedocs.org/projects/quipcell/badge/?version=latest)](https://quipcell.readthedocs.io/en/stable/)
[![PyPI-Server](https://img.shields.io/pypi/v/quipcell.svg)](https://pypi.org/project/quipcell/)
-->
<p><a class="reference external" href="https://pyscaffold.org/"><img alt="Project generated with PyScaffold" src="https://img.shields.io/badge/-PyScaffold-005CA0?logo=pyscaffold" /></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="quipcell">
<h1>quipcell<a class="headerlink" href="#quipcell" title="Link to this heading">¶</a></h1>
<blockquote>
<div><p>Fine-scale cellular deconvolution based on Generalized Cross Entropy</p>
</div></blockquote>
<p>A method to perform cellular deconvolution at a fine-scale
(i.e. single-cell or neighborhood level), using a generalization of
maximum entropy that is also an efficient convex optimization problem.</p>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h2>
<p>Installation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">quipcell</span>
</pre></div>
</div>
</section>
<section id="method">
<h2>Method<a class="headerlink" href="#method" title="Link to this heading">¶</a></h2>
<p>A preprint describing the method will appear on bioRxiv shortly.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>The <a class="reference external" href="https://genentech.github.io/quipcell/">documentation</a> includes a
<a class="reference external" href="https://genentech.github.io/quipcell/vignette.html">vignette</a> and
<a class="reference external" href="https://genentech.github.io/quipcell/api/modules.html">API reference</a>.</p>
<p>The snippet below demonstrates how to obtain weights from two
AnnData’s containing the single cell reference and the bulk samples to
deconvolve. Both AnnDatas are assumed to contain the raw counts, and
to have the same genes. Dimensionality reduction steps (PCA and LDA)
are run on the single cell reference, then applied to the bulk data,
and then quipcell estimates single cell weights using a generalized
maximum entropy method. The resulting weights represent the
probability that a random read from the bulk sample originated from
“near” the reference cell.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">from</span> <span class="nn">sklearn.discriminant_analysis</span> <span class="kn">import</span> <span class="n">LinearDiscriminantAnalysis</span>

<span class="c1"># save the number of UMIs per cell</span>
<span class="n">adata_ref</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;n_umi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_ref</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normalize the single cell reference</span>
<span class="n">normalize_sum</span> <span class="o">=</span> <span class="mf">1e3</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata_ref</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="n">normalize_sum</span><span class="p">)</span>

<span class="c1"># Compute low dimensional features via PCA and LDA on the single cells</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata_ref</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">lda</span> <span class="o">=</span> <span class="n">LinearDiscriminantAnalysis</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">lda</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">adata_ref</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_pca&#39;</span><span class="p">],</span> <span class="n">adata_ref</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">])</span>

<span class="n">adata_ref</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_lda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">adata_ref</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_pca&#39;</span><span class="p">])</span>

<span class="c1"># Normalize the bulk samples</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata_bulk</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="n">normalize_sum</span><span class="p">)</span>

<span class="c1"># Apply PCA rotation to pseudobulks. Note the centers need to be</span>
<span class="c1"># subtracted before rotation</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">adata_bulk</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">adata_ref</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">adata_ref</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s1">&#39;PCs&#39;</span><span class="p">])</span>
<span class="n">adata_bulk</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_pca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
<span class="c1"># Apply LDA rotation to pseudobulks</span>
<span class="n">adata_bulk</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_lda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Compute the weights. Rows are reference single cells, columns are</span>
<span class="c1"># bulk samples. The entries represent the probability that a random</span>
<span class="c1"># read from the bulk sample originated near the respective reference</span>
<span class="c1"># cell.</span>
<span class="n">w_reads</span> <span class="o">=</span> <span class="n">qpc</span><span class="o">.</span><span class="n">estimate_weights_multisample</span><span class="p">(</span><span class="n">adata_ref</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_lda&#39;</span><span class="p">],</span>
                                         <span class="n">adata_bulk</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;X_lda&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">quipcell</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="vignette.html">Vignette</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">Module Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributions &amp; Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">quipcell</a></li>
      <li>Next: <a href="vignette.html" title="next chapter">Example application of quipcell to human lung cell atlas</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Jack Kamm.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/readme.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>